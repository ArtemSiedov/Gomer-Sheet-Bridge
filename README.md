# Gomer Sheet Bridge
### Chrome extension for Gomer -> Google Sheets

Расширение добавляет кнопки на страницах Gomer, собирает параметры товара и записывает данные в Google Sheets.

## Что умеет
- Добавляет кнопки экспорта на страницах Gomer.
- Работает в контекстах: `on-moderation`, `active`, `changes`, `item-details`, `binding-attribute-page`.
- Пишет строки в Google Sheets через API.
- Запускает обработку в фоне через очередь.
- Ведет лог очереди в шапке Gomer.
- Поддерживает остановку задач (`Kill`) для `pending` и `processing`.
- Автоочищает историю `done/error` задач через 5 часов.

## Новые поля в Popup
В popup (`src/popup/popup.html`) сейчас 4 поля:
- `Ссылка на Google Sheet`
- `Учитывать номер заявки при выборке offerId` (по умолчанию включено)
- `Генерировать ссылку на товар` (по умолчанию включено)
- `Свой номер заявки (опционально)`

## Логика чекбоксов
### `Учитывать номер заявки при выборке offerId`
- `ON`: `ItemSearch[bpm_number]` участвует в сборе offerId.
- `OFF`: номер задачи записывается в файл, но в выборке offerId не участвует.

### `Генерировать ссылку на товар`
- `ON`: расширение собирает offerId, ищет в прайсе и пытается построить ссылку на товар.
- `OFF`: поиск offerId и прайса полностью пропускается, строка пишется без ссылки на товар.

## Очередь и фоновая обработка
- Добавление в файл идет через background-очередь (`ENQUEUE_EXPORT_TASK`).
- Статусы: `pending`, `processing`, `done`, `error`.
- Можно удалить/остановить конкретную задачу кнопкой `Kill`.
- История `done/error` хранится 5 часов, затем удаляется автоматически.

## Как собираются offerId
- Сбор идет со страницы `items/source` (или `active/changes` по контексту) с пагинацией.
- Основной размер страницы для служебного сбора: `500`.
- Парсинг только по шаблону `Offer ID: ...` (строгий режим, без лишних ID из других мест).
- В консоль выводятся debug-логи:
  - запросы `[RW][OFFER_IDS][REQUEST] ...`
  - итоговый список `[RW][OFFER_IDS] count= ... ids= ...`

## Таймауты и ошибки
- На загрузку служебных страниц сбора стоит таймаут `30s`.
- Если прайс/поиск недоступен (`504`, timeout и т.п.), строка в Google Sheets все равно добавляется без ссылки.

## Требования
- Google Chrome (Developer mode).
- Google Cloud проект с включенным `Google Sheets API`.
- OAuth Client ID для Chrome Extension.
- Доступ к Gomer и прайсам поставщика.

## Установка
1. Открой `chrome://extensions`.
2. Включи `Developer mode`.
3. Нажми `Load unpacked`.
4. Выбери папку проекта `Gomer Sheet Bridge`.

## Настройка Google Cloud
1. Создай/открой проект в Google Cloud.
2. Включи `Google Sheets API`.
3. Настрой `OAuth consent screen`.
4. Создай OAuth client для Chrome Extension и укажи `Extension ID`.
5. Scope: `https://www.googleapis.com/auth/spreadsheets`.

## Первый запуск
1. Открой popup расширения.
2. Вставь ссылку на таблицу.
3. Настрой чекбоксы под задачу.
4. Нажми `Сохранить`.
5. На странице Gomer нажми кнопку добавления рядом с параметром.
6. Наблюдай прогресс в `Gomer Sheet Bridge Log` в шапке.

## Колонки в Google Sheets
В первой строке таблицы должны быть названия:
- `Дата добавления`
- `Категория товара`
- `Атрибут`
- `Значение параметра`
- `Номер задачи`
- `Ссылка на товар`

## Важное по безопасности
- `extension.pem` не коммить в репозиторий.
- `.pem` держи только локально/в защищенном хранилище.

## Privacy Policy
- `PRIVACY.md`
- `privacy-policy.html`
